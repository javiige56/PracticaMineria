---
title: "Mundial de natación de Kazán 2015"
author: "Inés Molinero, Javier Villanueva, Salma Ghailan, Alonso González"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float:
      collapsed: true
editor_options: 
  markdown: 
    wrap: sentence
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Cargamos las librerias que vamos necesitando a lo largo del codigo
library(dplyr)
library(rstatix)
library(ggplot2)
library(tidyr)
library(ggimage)
library(countrycode)
library(ggExtra)
```

#1.
Introducción.

En este proyecto, se analizarán los resultados del mundial de natación de 2015 con el objetivo de identificar patrones en el desempeño de los nadadores por país y eventos.
Se realizará un análisis exploratorio de datos y se utilizarán técnicas de reducción de dimensionalidad, aprendizaje no supervisado, aprendizaje supervisado, medidas de rendimiento, comparación de modelos y técnicas de Aprendizaje Máquina Explicable

En primer lugar, vemos con qué datos vamos a tratar.
El conjunto de datos consiste en los resultados del Campeonato Mundial de Natación Kazán del año 2015, con los correspondientes datos de cada nadador y prueba.
Los datos han sido extraídos de [Omega](http://www.omegatiming.com/File/Download?id=00010F0200FFFFFFFFFFFFFFFFFFFF08), la plataforma oficial de tiempos de la World Aquatics.
El conjunto de datos contiene información sobre los nadadores (fecha de nacimiento, país, id), y sobre la prueba nadada (tiempo de reacción, parciales, tiempo total, estilo, serie).

Las variables o atributos que conforman el conjunto de datos son:

-   athleteid: id del nadador (único)
-   lastname: Apellidos del nadador
-   firstname: El nombre del nadador
-   birthdate: Fecha de nacimiento del nadador
-   gender: Género del nadador/a
-   name: Nombre del país
-   code: abreviatura del país.
-   eventid: id de la prueba nadada (único)
-   heat: Serie en la que nadaron
-   lane: Calle en la que nadaron (0 a 9)
-   points: puntos FINA que realizaron. (es una "estimación" entre el mejor tiempo o récord del mundo, y el tiempo realizado. )
-   reactiontime: Tiempo de reacción en la salida.
-   swimtime: tiempo tardado
-   split: Parcial
-   cumswimtime: Tiempo acumulado en el parcial
-   splitdistance: Distancia del parcial
-   daytime: hora a la que se nadó
-   round: ronda (preliminar, semifinal, final)
-   distance: distancia de la prueba
-   relaycount: Número de relevista.
-   stroke: Estilo de nado en el que se realizó la prueba.
-   splitswimtime: Tiempo del parcial (50m)

# Entender los datos.

Primeramente, vamos a leer los datos:

```{r}
datos2015<-read.csv("datos/2015_FINA.csv", header=TRUE, sep = ',')
```

Una vez nuestro programa los ha leído, vamos a averiguar el tamaño de los datos con los que vamos a tratar:

```{r}
dim(datos2015)
```

Las dimensiones de la tabla son 11423 filas y 22 variables o columnas.

Veámos la primera ocurrencia de nuestra tabla:

```{r}
head(datos2015,1)
```

Observamos Noel Borshi, nadadora albanesa nacida un 13 de febrero de 1996, que tiene como id el número (100784).
Noel Borshi nadó la prueba 1 en la serie 1 y carril 4.
Nadó el 100m Mariposa en la ronda preliminar con un tiempo final de 63.65s y pasó por el primer parcial (50m) en 29.63 segundos.

# Análisis exploratorio de datos.

## Resumen de los datos.

A continuación, vamos a ver un resumen de los datos:

```{r}
summary(datos2015)
```

De aquí, podemos observar que tenemos algunos valores nulos (NA's), durante toda la competición, que como máximo hubo 12 series y como mínimo 1 y que la piscina disponía de 10 carriles numerados del 0 al 9.
También observamos que se nadaron pruebas de 50 y hasta 1500 metros.

Tenemos variables categóricas las cuales no se ven bien en el resumen anterior, por lo que, usando la librería "dyplr", vamos a convertirlas a varaibles categóricas en R para tener una mejor visualización de ellas.

```{r}
datos2015<- datos2015 %>% convert_as_factor(gender,name,code,round,heat,lane,stroke)
```

Visualicemos ahora de nuevo el resumen:

```{r}
summary(datos2015)
```

Observamos que las variables name y code toman absolutamente los mismos valores, luego seguramente podamos reducir en una variable el conjunto de datos.
También se nadaron pruebas de espalda, braza, mariposa, crol y estilos individual, las pruebas las disputaron hombres y mujeres, el menor tiempo de reacción fue de 0.42 y el mayor de 0.97.

Viendo los datos, observamos que cada nadador tiene en una prueba concreta, tantas filas como parciales tenía en esa prueba, luego es obvio que para conocer mejor algunas variables, vamos a necesitar limpiar los datos para que los elementos repetidos no causen interferencia en nuestros datos.

## Creación de nueva variable edad.

Lo primero que vamos a hacer, va a ser crear una nueva variable, llamada *edad*, ya que será más representativo que trabajar con la variable birthdate.
La variable tendrá el valor numérico de la edad de cada participante en el momento del mundial.
Es decir, el 24 de Julio de 2015.

```{r}
datos2015$birthdate <- as.Date(datos2015$birthdate)
#Calculamos la edad
fechaKazan<- as.Date("2015-07-24")
datos2015$edad <- as.numeric(difftime(fechaKazan, datos2015$birthdate, units = "weeks")) %/% 52  # Convertir de semanas a años
```

## Estudio sobre el número de nadadores, su género, país y edad.

Para estudiar el número de nadadores, ver cuantos hombres y mujeres había, la edad de los participantes, vamos a necesitar eliminar filas como bien hemos anunciado antes.

Por ello, vamos a crear una nueva tabla, llamada *nadadoresParticipantes*, la cual constará de todos los participantes sin repetir.
Para ello usamos la variable athleteid, la cual es única para cada participante.

```{r}
nadadoresParticipantes <- datos2015 %>%
  distinct(athleteid, .keep_all = TRUE)
```

```{r}
summary(nadadoresParticipantes)
```

Ahora, comenzamos nuestro estudio:

### Edad

Veamos primeramente un resumen de la edad:

```{r}
summary(nadadoresParticipantes$edad)
```

Observamos que la edad máxima fue de 38 años, la media fue de 21.32 años, y el participante con menos edad fue de 10 años.
Además, el 50% de los participantes estaban entre 19 y 24 años de edad.

Una pregunta razonable sería: ¿El dato relativo al participante de 10 años es un error?

Procedemos a contrastar la información.
De esta forma, podemos ver si de verdad existe este atleta o es un dato mal tomado de nuestra base de datos.
Confirmamos la información, entre otras fuentes, con esta noticia, de la cual añadimos el enlace sobre la joven nadadora de 10 años.
[noticia](https://www.rtve.es/deportes/20150807/nina-10-anos-alzain-tareq-asombra-a-natacion-mundial/1195782.shtml#:~:text=Se%20llama%20Alzain%20Tareq%2C%20tiene,estrella%20medi%C3%A1tica%20de%20la%20jornada.)

Confirmamos mediante su nombre, apellidos y edad, que la noticia se refiere a los datos que tenemos.

```{r}
datos_edad_10 <- datos2015[datos2015$edad == 10, ]
datos_edad_10
```

Se trata de una nadadora de Bahrain que nadó el 50 mariposa y el 50 libres.
Luego podemos concluir que es un dato atípico pero no es erróneo.

De acuerdo con esta nueva variable, vemos cómo se distribuyen las edades.

```{r}
ggplot(nadadoresParticipantes, aes(x = edad)) +
geom_density() +
ggtitle("Distribución. Edades.")
```

La mayoría de los nadadores parecen tener entre 15 y 25 años, con un pico alrededor de los 20 años.
Esto sugiere que los participantes en la competición están en su mayoría en la etapa juvenil o temprana adultez.

### Análisis de géneros participantes.

Veamos el número exacto de mujeres y hombres en la competición:

```{r}
summary(nadadoresParticipantes$gender)
```

Luego, hay 616 hombres y 494 mujeres que participaron en los mundiales de Kazán 2015.

Veamos ahora cómo se distribuyen los hombres y las mujeres y sus respectivas edades:

```{r}
ggplot(nadadoresParticipantes, aes(x = edad, colour = gender)) +
# Añadir la capa de la densidad de probabilidad.
    geom_density()
```

Según observamos, la distribución está ligeramente desplazada a la derecha para los hombres, esto indica que los hombres tienden a ser mayores en promedio que las mujeres.
Esta diferencia en la distribución de edades entre los géneros nos conduce a realizar distintos test estadísticos para confirmar si la diferencia realmente es significativa.

#### Hipótesis:

\*\*Hipótesis nula\*\* (\\(H_0\\)): Las medias de los dos grupos son iguales.
\*\*Hipótesis alternativa\*\* (\\(H_1\\)): Las medias de los dos grupos son diferentes.

```{r}
t.test(edad~gender,data=nadadoresParticipantes)

```

Hemos comparado las medias de edad entre mujeres (grupo F) y hombres (grupo M), tomando como hipótesis nula que las medias de edad entre mujeres y hombres son iguales, y cómo hipótesis alternativa que las medias de edad entre mujeres y hombres son diferentes.
Aunque el resultado del t-test muestra que hay una diferencia estadísticamente significativa (el p-valor es muy pequeño) entre las edades medias de hombres y mujeres (aproximadamente 1.16 años), en términos prácticos, esta diferencia es relativamente pequeña.
En este caso, puede no ser relevante en términos de la experiencia o desempeño de los nadadores.

No obstante, proseguimos en nuestro análisis exploratorio.

```{r}
tabla1<-table(nadadoresParticipantes$edad>30,nadadoresParticipantes$gender)
chisq.test(tabla1)
```

Por el resultado del siguiente test aplicado,podemos concluir con que **no hay asociación significativa**: Dado que el p-valor es 0.47, entre ser mayor de 30 años y el género de los nadadores en nuestros datos.
En términos sencillos,la edad no parece estar relacionada con el género de los nadadores en cuanto a si son mayores de 30 años.

```{r}
tabla2<-table(nadadoresParticipantes$edad<20,nadadoresParticipantes$gender)
chisq.test(tabla2)
```

Hay una diferencia considerable entre las frecuencias observadas (cuántos hombres y mujeres son menores de 20 años) y las frecuencias esperadas bajo la hipótesis nula (que no hay asociación entre edad y género para menores de 20 años).
Esto sugiere ir un paso más allá, ¿Hay más mujeres menores de edad que hombres menores de edad?

```{r}
tabla3<-table(nadadoresParticipantes$edad<18,nadadoresParticipantes$gender)
chisq.test(tabla3)
```

Los resultados sugieren que el género y la minoría de edad si que están significativamente relacionados en nuestro conjunto de datos de nadadores.
Esto podría tener implicaciones para el análisis del rendimiento y la participación en competiciones.

Veamos números,

```{r}
tabla3

#Calcular los totales
totales <- colSums(tabla3)

#Calcular el porcentaje de nadadores menores de 18 años por género
porcentajes <- (tabla3[2, ] / totales) * 100  
# fila 2 son los menores de 18

porcentajes
```

De esta forma, ya habiendo confirmado una diferencia significativa.
Podemos ver, de manera más representativa, como existe el doble de proporción de mujeres menores de edad en comparación con los hombres.
Dicho en otras palabras, 2 de cada 10 mujeres son menores de 18 años, mientras que esto sólo ocurre en 1 de cada 10 hombres.

### Análisis de nacionalidades.

Vamos a ver la cantidad de nadadores por país.

```{r}

# Utilizamos la tabla nadadoresParticipantes
# Agregar el código ISO de dos dígitos. No es posible con la variable CODE, hay que convertir.
nadadoresParticipantes$iso2 <- countrycode(nadadoresParticipantes$name, "country.name", "iso2c")
#Vemos que salta error EN FINA, KOSOVO,MICRONESIA Y VIRGIN ISLAND
#Por tanto, revisamos los datos 
nombres<- unique(nadadoresParticipantes$name) #Para no repetir
print(nombres)


#Nombres problemáticos
manual <- data.frame(
  nombre = c("Fina", "Kosovo", "Micronesia", "Virgin Islands"),
  iso2 = c("FI", "XK", "FM", "VI")  
)

# Agregamos la variable continente 
nadadoresParticipantes$continent <- countrycode(nadadoresParticipantes$iso2, "iso2c", "continent")
#vuelve a fallar

#solo es XK(KOSOVO, que está en Europa)
#manualmente el continente para Kosovo (XK)
nadadoresParticipantes <- nadadoresParticipantes %>%
  mutate(continent = ifelse(iso2 == "XK", "Europe", continent))  



#nadadores por país
resumen_paises <- nadadoresParticipantes %>%
  group_by(name, iso2, continent) %>%
  summarise(num_nadadores = n(), .groups = "drop") %>%
  arrange(desc(num_nadadores))  # Ordenar por número de nadadores

resumen_paises

#Creamos un gráfico con colores
paleta <- c("Americas" = "#0084ff", "Asia" = "#44bec7", 
            "Europe" = "#ffc300", "Oceania" = "#fa3c4c")

oda_bar <- resumen_paises %>% 
  ggplot(aes(x = reorder(name, num_nadadores), y = num_nadadores, fill = continent)) + 
  geom_flag(y = -10, aes(image = iso2), size = 0.05) +  
  geom_bar(stat = "identity") + 
  labs(title = "Participación de Nadadores por País",
       subtitle = "Datos de nadadores en competiciones",
       x = "País",
       y = "Número de Nadadores") +
  scale_fill_manual(values = paleta) +  # colores personalizados
  expand_limits(y = c(0, max(resumen_paises$num_nadadores) + 10)) +  # Aumentar el límite superior
  coord_flip() +  # Para hacer el gráfico horizontal
  theme_minimal()

# Imprimir el gráfico
print(oda_bar)
```

Vemos también este mismo gráfico, pero separando los países por continentes.

```{r}
paleta <- c("Americas" = "#0084ff", 
            "Asia" = "#44bec7", 
            "Europe" = "#ffc300", 
            "Oceania" = "#fa3c4c")

oda_bar1 <- resumen_paises %>% 
  ggplot(aes(x = reorder(name, num_nadadores), 
             y = num_nadadores, 
             fill = continent)) + 
  geom_flag(y = -10, aes(image = iso2), size = 0.05) +  
  geom_bar(stat = "identity") + 
  labs(title = "Participación de Nadadores por País",
       subtitle = "Datos de nadadores en competiciones",
       x = "País",
       y = "Número de Nadadores") +
  scale_fill_manual(values = paleta) +  # Colores personalizados
  expand_limits(y = c(0, max(resumen_paises$num_nadadores) + 10)) +  # Ajustar el límite superior
  coord_flip() +  # Gráfico horizontal
  theme_minimal() +
  facet_wrap(~ continent, scales = "free_y")  # Separar por continentes

# Imprimir el gráfico
print(oda_bar1)

```

Como vemos, estos gráficos son poco interpretables debido a la gran cantidad de países.
Por ello, realizaremos un gráfico reduciendo la dimensión, juntando en un grupo llamado 'Otros' a aquellos países con menos de 10 nadadores.
*añadirlo*

```{r}
paleta <- c("Americas" = "#0084ff", 
            "Asia" = "#44bec7", 
            "Europe" = "#ffc300", 
            "Oceania" = "#fa3c4c" 
            ) 



# Crear una nueva columna que agrupe países con menos de 10 nadadores en "Otros"
resumen_paises4 <- resumen_paises %>%
   filter(num_nadadores >= 10)
resumen_paises4

# Crear el gráfico
oda_bar3 <- resumen_paises4 %>% 
  ggplot(aes(x = reorder(name_group, num_nadadores), 
           y = num_nadadores, 
           fill = continent)) + 
  geom_flag(y = -5, aes(image = iso2), size = 0.05) + 
  geom_bar(stat = "identity") + 
  labs(title = "Participación de Nadadores por País",
       subtitle = "Países con menos de 10 nadadores ocultados",
       x = "País",
       y = "Número de Nadadores") +
 scale_fill_manual(values = paleta) +  # Colores personalizados
  expand_limits(y = c(0, max(resumen_paises4) + 10)) +  # Ajustar el límite superior
  coord_flip() +  # Gráfico horizontal
  theme_minimal()

# Imprimir el gráfico
print(oda_bar3)

```

```{r}
paleta <- c("Americas" = "#0084ff", 
            "Asia" = "#44bec7", 
            "Europe" = "#ffc300", 
            "Oceania" = "#fa3c4c")

# Crear el histograma de cantidad de nadadores por continente
histograma_nadadores <- resumen_paises %>% 
  ggplot(aes(x = continent, y = num_nadadores, fill = continent)) + 
  geom_bar(stat = "identity") +  # Sumar cantidad de nadadores por continente
  labs(title = "Cantidad de Nadadores por Continente",
       x = "Continente",
       y = "Número de Nadadores") +
  scale_fill_manual(values = paleta) +  # Colores personalizados por continente
  theme_minimal()

# Imprimir el histograma
print(histograma_nadadores)

```

Como podemos observar en los gráficos, la mayor cantidad de nadadores son de procedencia europea, continuando con Asia y Américas, y teniendo baja proporción los nadadores de África y Oceanía.
Nos preguntamos en esta situación, si los Europeos tendrán los puestos más altos en el ranking.
Es decir, si existe mayor proporción de ganadores en los países con más densidad de participantes.

Para ello, analizaremos los puntos según las nacionalidades de los nadadores.

```{r}
puntos_por_pais <- nadadoresParticipantes %>%
  group_by(name) %>%  
  summarise(total_puntos = sum(points, na.rm = TRUE))  

# Ver el resultado
print(puntos_por_pais)

```

```{r}
#Graficar los puntos por país
ggplot(puntos_por_pais, aes(x = reorder(name, total_puntos), y = total_puntos)) +
  geom_bar(stat = "identity", fill = "steelblue") +
  labs(title = "Total de Puntos por País", x = "País", y = "Total de Puntos") +
  coord_flip() +  # Voltear el gráfico para una mejor visualización
  theme_minimal()

```

De la misma manera que nos ocurría antes, este gráfico es poco interpretativo.
Lo vemos por continentes:

```{r}
puntos_por_continente <- nadadoresParticipantes %>%
  group_by(continent) %>%  #agrupar por continente
  summarise(total_puntos = sum(points, na.rm = TRUE))  #Sumar puntos por continente

print(puntos_por_continente)
```

```{r}
#Graficar los puntos por continente
ggplot(puntos_por_continente, aes(x = reorder(continent, total_puntos), y = total_puntos, fill = continent)) +
  geom_bar(stat = "identity") +
  labs(title = "Total de Puntos por Continente", x = "Continente", y = "Total de Puntos") +
  coord_flip() + 
  theme_minimal()
```

```{r}
ggplot(na.omit(nadadoresParticipantes), aes(x = points, colour = continent)) +
# Añadir la capa de la densidad de probabilidad.
    geom_density()

ggplot(na.omit(nadadoresParticipantes), aes(x=continent, y=points, color=continent)) +
  geom_boxplot()
```

Como podemos observar, parece ser que los Europeos son mejores en el desempeño de las pruebas de natación.
Además, presentan una distribución más centrada a la media y sus valores más altos están bastante alejados del resto de los del resto de participantes de otros continentes.
Podríamos interpretar que América tiene la segunda distribución más centrada en comparación con el resto de continentes.
La esperanza está cercana a Oceanía por debajo pero con menor dispersión.
Oceanía también presenta una media bastante alta y cercana a la de Europa.
sin embargo, se puede ver como su dispersión es bastante elevada por lo que presenta nadadores de diversa cualificación.
La peor esperanza la tiene África, muy por debajo este valor del resto de los continentes.
Además presenta una gran dispersión, ya que abarca el rango desde valores cercanos al 0 hasta 1000, sin ser estos visualizados como outliers.
Esta información nos podría ser de gran ayuda para dar un posible enfoque a la hora de establecer tendencias en los grupos y a qué se puede deber (clima, tipo de entrenamiento, condiciones sociales en diversos países) la cantidad de puntos en promedio y la variabilidad de estas observaciones.

## Estudio sobre la relación entre la edad de los nadadores y las distancias que nadan. (? Salma)

```{r}
#Crear una nueva columna para clasificar por edad
nadadoresParticipantes <- nadadoresParticipantes %>%
  mutate(grupo_edad = ifelse(edad < 18, "Menores de 18", "18 y más"))

#Resumir el número de participantes en cada prueba por grupo de edad
resumen_pruebas <- nadadoresParticipantes %>%
  group_by(grupo_edad , distance) %>%  # Agrupar por grupo de edad y prueba(LO MIRO POR DISTANCIAS)
  summarise(num_participantes = n(),.groups = "drop") %>%  #Contar el número de participantes
  ungroup() %>%  # Quitar agrupación
  arrange(grupo_edad, desc(num_participantes))  #Ordenar los resultados

# Mostrar el resumen
resumen_pruebas

```

Tenemos la distancia de 100 metros, con 405 participantes.
Es la distancia más popular entre los nadadores mayores de 18 años.
Le sigue la distancia de 209 participantes, la de 200 metros.
200 metros: Con 209 participantes, sigue siendo una distancia muy popular.
La participación disminuye considerablemente en distancias más largas, como 1500 metros con solo 13 participantes.
Para los menores de 18 años tenemos carreras de 100 metros con 75 participantes, esta es la distancia más frecuentada, aunque significativamente menos que el grupo de 18 años o más.
La participación en distancias más largas, como 400 metros, es aún más baja, con solo 19 participantes.

Los nadadores mayores de 18 años tienen una participación significativamente mayor en todas las distancias en comparación con los menores de 18 años.
La mayor diferencia se observa en la distancia de 100 metros, donde hay 405 participantes en el grupo de 18 años o más, en comparación con solo 75 en el grupo de menores de edad.
La participación en distancias más largas tiende a ser baja en ambos grupos, pero la caída es más pronunciada en los menores de 18.

Tratando de analizar los datos obtenidos podemos concluir con que la distancia de 100 metros es la más popular entre los nadadores.
Sin embargo, la diferencia en el número de participantes entre ambos grupos de edad es significativa(más de 5 veces mayor entre los mayores de 18 años).
Este es un dato que es evidente con nuestras observaciones anteriores, ya que vimos que la media de los participantes está en torno a 21 años.
Por tanto, hay más de la mitad de los participantes en el segundo grupo.
Lo que si podemos apreciar es que se observa una tendencia de disminución en la participación a medida que las distancias aumentan.

Para poder analizar correctamente la tendencia de los nadadores según su grupo de edad, no podemos quedarnos en las frecuencias absolutas.
Debemos analizar los resultados según sus frecuencias relativas.

```{r}
total_menores_18 <- nadadoresParticipantes %>%
  filter(edad < 18) %>%  # Filtrar solo los menores de 18
  summarise(total = n())  # Contar el número total de participantes

# Mostrar el resultado
print(total_menores_18) 

total_mayores<- nadadoresParticipantes %>%
  filter(edad >= 18) %>%  # Filtrar solo los menores de 18
  summarise(total = n())  # Contar el número total de participantes

# Mostrar el resultado
print(total_mayores)
resumen_relativo <- resumen_pruebas %>%
  mutate(
    frecuencia_relativa = ifelse(grupo_edad == "Menores de 18", 
                                 round(num_participantes / 174, 3),  # División para "Menores de 18" con 3 decimales
                                 round(num_participantes / 936, 3))  # División para "18 y más" con 3 decimales
  )

print(resumen_relativo)
```

Como podemos observar mejor aquí, las diferencias con la edad entre las pruebas a las que se presentan los participantes no son representativas.
En torno al 43% de los mayores y menores de edad se presentan a la prueba de 100 metros, mientras que para la de 200 metros son en torno a un 22-25%.
La diferencia en este caso es de un 3%, y en el resto de pruebas es poco representativo debido a la poca cantidad de participantes en ellas.
Por tanto, parece ser que no existe una relación entre tipo de prueba y edad.

## Estudio sobre los eventos, reactiontime, lane, heats y daytime:

Para poder elaborar un estudio de algunas variables como *events*, *reactiontime*, *lane*, *heats* y *daytime*, vamos a necesitar una tabla que refleje a cada nadador y sus pruebas nadadas por filas.

Para poder realizar la tabla, primero hay que saber si cada prueba, dentro de cada tipo de prueba (preliminar, final, semifinal), tiene un id distinto.
Lo evaluamos seleccionando algún nadador que haya nadado en varias rondas:

```{r}
ejemplo<-datos2015[datos2015$distance == 100 & datos2015$stroke=="BACK" & datos2015$code=="AUS", ]
head(ejemplo,6)
```

Bien, vemos que el australiano nadó tanto las preliminares, como las semifinales como la final y el eventid era distinto, luego parece que podemos seguir con nuestro estudio.
Creamos la siguiente tabla:

```{r}
nadadoresPruebas <- datos2015 %>%
  distinct(eventid, athleteid, .keep_all = TRUE)
nadadoresPruebas
```

Los datos creados, reflejan nadadores y pruebas nadadas por cada uno.

### Reactiontime. Hombres vs Mujeres

Veamos cómo se distribuyen los datos de tiempo de reacción de todos los nadadores:

```{r}
ggplot(nadadoresPruebas, aes(x = reactiontime)) +
geom_density() +
ggtitle("Distribución. reactiontime")

```

Parece que los datos siguen una distribución normal a priori.
Vamos a ir más alla para intentar sacar conclusiones más profundas.

Vamos a comparar las funciones de densidad de chicos y chicas en general:

```{r message=FALSE, warning=FALSE}
ggplot(nadadoresPruebas, aes(x=reactiontime, colour=gender))+
geom_density()+
  ggtitle("Distribución. Hombres vs Mujeres")
```

De esta gráfica nos surgen muchas preguntas, vamos a analizar esto más a fondo.
Hagamos un test de hipótesis donde:

-   H0: El tiempo de reacción es igual en mujeres y hombres.
-   H1: El tiempo de reacción es menor en hombres que en mujeres.

```{r}
t.test(reactiontime~gender,data=nadadoresParticipantes)
```

De manera similar a lo realizado previamente, el p- valor nos indica que hay una evidencia significativa en rechazar la hipótesis nula, y por ende concluir con que hay una diferencia estadística en el tiempo de reacción dependiendo del género.
Ahora que hemos determinado que la diferencia es estadísticamente significativa, es importante considerar si la diferencia es también significativa en la práctica o si tiene relevancia a la hora de los resultados finales.
Por ejemplo, de las mujeres/hombres que tienen un tiempo de reacción más bajo y aquellas/os que tienen un tiempo de reaccion más alto,¿ le corresponden puestos mas altos y bajos respectivamente?
No podemos precipitarnos a decir que la diferencia es muy pequeña ya que habría que hacer un análisis adicional para medir la magnitud la diferencia (como el de Cohen).
Esto nos diría cómo es de grande la diferencia en términos de desviaciones estándar.

### Reactiontime. Distancias largas vs distancias cortas.

Vamos a comparar ahora las funciones de densidad de las chicas en la prueba de 800m libres y 50m libres:

Primeramente calculamos el conjunto de datos:

```{r}
nadadorasComparacionReactionTime<-nadadoresPruebas[(nadadoresPruebas$distance==50 | nadadoresPruebas$distance==800) & nadadoresPruebas$gender=="F" & nadadoresPruebas$stroke=="FREE", ]
```

```{r}
ggplot(nadadorasComparacionReactionTime, aes(x = reactiontime,group=distance)) +
geom_density() +
ggtitle("Distribución. Reaction time: 800m free vs 50m free")

```

El gráfico muestra dos curvas de densidad superpuestas, una para la prueba de 50 metros y otra para 800 metros.
Las curvas se encuentran en un rango de aproximadamente 0.6 a 0.9, que representa los tiempos de reacción.
La advertencia en la consola indica que algunos valores fueron eliminados debido a ser no finitos, lo que sugiere que puede haber valores faltantes u outliers en los datos de tiempo de reacción.
Para los 50 metros, la densidad es más alta en el rango de tiempos de reacción más cortos, lo que indica que las nadadoras tienden a tener tiempos de reacción más rápidos en esta distancia.
Esto es esperado, ya que la carrera de 50 metros es más corta y requiere reacciones más rápidas y explosivas.
En cuanto a la de 800 metros, la curva muestra una mayor dispersión en los tiempos de reacción, con una densidad más amplia.
Esto sugiere que los tiempos de reacción son más variados en esta distancia, probablemente debido a la naturaleza más larga y estratégica de la carrera, donde las nadadoras pueden no necesitar un tiempo de reacción tan rápido.

Aquí también podemos hacer un test de hipótesis.

```{r}
t.test(reactiontime~distance,data=nadadorasComparacionReactionTime)
```

Veamos nuestros resultados del test.
Por un lado tenemos el valor del estadístico t calculado, como es un valor negativo indica que la media del primer grupo (50 metros) es menor que la del segundo grupo (800 metros).El valor del p-valor (que es extremadamente bajo) indica que hay una diferencia estadísticamente significativa entre las medias de los dos grupos.
Las nadadoras que participan en distancias más cortas (50 metros) tienen un tiempo de reacción más rápido en comparación con aquellas que nadan distancias más largas (800 metros).Luego, habíamos identificado correctamente la tendencia del gráfico, en términos estadísticos.

A continuación, realizamos el mismo estudio pero con hombres y vemos si la situación es similar.

```{r}
nadadoresComparacionReactionTime<-nadadoresPruebas[(nadadoresPruebas$distance==50 | nadadoresPruebas$distance==800) & nadadoresPruebas$gender=="M" & nadadoresPruebas$stroke=="FREE", ]
```

```{r}
ggplot(nadadoresComparacionReactionTime, aes(x = reactiontime,group=distance)) +
geom_density() +
ggtitle("Distribución para Hombres. Reaction time: 800m free vs 50m free")

```

```{r}
t.test(reactiontime~distance,data=nadadoresComparacionReactionTime)
```

Al realizar el t-test para este grupo, vemos también como la diferencia es significativa entre el tiempo de reacción para la prueba de 50 metros y la de 800.

La diferencia entre estos dos extremos en las pruebas es muy significativa, pero queremos saber también como se distribuyen todas.
Es decir, cuál es la diferencia entre las pruebas de 50 metros, las de 100, 200, etc.
Para ello, realizaremos un gráfico de densidad conjunto.

```{r}
ggplot(na.omit(nadadoresPruebas), aes(x = reactiontime, color = as.factor(distance), fill = as.factor(distance))) +
  geom_density(alpha = 0.5) +  # Ajustar la transparencia
  ggtitle("Distribución comparada de Reaction time") +
  labs(x = "Tiempo de Reacción", y = "Densidad", color = "Distancia", fill = "Distancia") +
  theme_minimal()
```

Como podemos observar, nuestras suposiciones parecen ser ciertas acerca de que las medias de los tiempos de reacción aumentan según la carrera es más larga.
Si bien es cierto, para distancias largas, como son 800 y 1500 metros, no se observan diferencias en torno a su valor central.
Del mismo modo, para carreras de 100 y 200 tampoco se observa una diferencia signifiticativa.
Contrastamos esto de forma más precisa realizando el test ANOVA de diferencia de medias.

```{r}
anova_tiempoReaccion_distancia <- aov(reactiontime ~ as.factor(distance), data = na.omit(nadadoresPruebas))
summary(anova_tiempoReaccion_distancia)
```

Interpretando estos resultado, tenemos que el valor p es un valor de orden e\^-16.
Por ello, podemos concluir que hay diferencias significativas en los tiempos de reacción entre al menos uno de los grupos de distancia.
Esto indica que, al menos una distancia tiene un tiempo de reacción diferente en comparación con las otras distancias.
El valor de F es alto (56.98), sugiere que la variación entre los grupos es mucho mayor que la variación dentro de los grupos.
Esto refuerza la idea de que las medias de los tiempos de reacción son significativamente diferentes entre las carreras de diferente distancia.

### Calles usadas (no está claro)

Veamos cómo se distribuyen las calles usadas:

```{r}
ggplot(nadadoresPruebas, aes(nadadoresPruebas$lane)) + geom_bar(fill = "orange") +
theme_bw()

```

Se observa que las calles menos usadas son tanto la 0 como la 9.
Esto es un dato que puede resultar curioso al visualizar los datos.
Por tanto, informándonos acerca de ello, tenemos que competir en las calles centrales conlleva algunas ventajas frente a las calles de los extremos.
Competir en estas calles influye positivamente en tener menos turbulencias y ondas causadas por otros nadadores, mejor visibilidad del resto de competidores pudiendo ajustar su estrategia según lo que suceda alrededor y genera más confianza debido al sentido de dominio que aportan estas calles.
Por tanto, sabiendo esto nos podríamos cuestionar cuánto influye en nuestros datos el número de calle en cada resultado.

¿Habrá alguna relación entre la calle usada y el tiempo de reacción?

```{r}
#me pareció guay este gráfico, alonso sabes interpretarlo? aupa

ggplot(nadadoresPruebas, aes(x = reactiontime, fill = lane)) +
  geom_histogram(binwidth = 0.01, alpha = 0.7, position = "identity") +
  facet_wrap(~ lane) +  # Crear facetas por calle
  theme_bw() +
  labs(title = "Distribución de Tiempos de Reacción por Calle",
       x = "Tiempo de Reacción",
       y = "Frecuencia") +
  scale_fill_brewer(palette = "Set1") 
```

Como podemos ver, no parece haber diferencias significativas según el tipo de calle en los tiempos de reacción.
De nuevo, podemos realizar un test anova sobre la diferencia de medias.

```{r}
anova_tiempoReaccion_Calles <- aov(reactiontime ~ as.factor(lane), data = na.omit(nadadoresPruebas))
summary(anova_tiempoReaccion_Calles)
```

El p-valor de nuestro análisis es menor de 0.005, por lo que podríamos sugerir que sí tiene cierta influencia según el número de calle empleada.
Sin embargo, existen muchas variables en nuestro conjunto de datos que podrían influir.
Si en las rondales finales no se ocupan las calles laterales y son las que necesitan más respuesta explosiva para lograr la victoria, parece claro que los valores de menores tiempos de reacción se localicen en las calles centrales.
Del mismo modo, podrían ocurrir otros factores no conocidos.
Por lo tanto, seguimos investigando acerca de ello.

Realizamos un modelo lineal para ver si existe una relación entre los puntos de los participantes y el número de calle en el que compiten.

```{r}
lmPuntosCalle = lm(nadadoresPruebas$points~nadadoresPruebas$lane)
summary(lmPuntosCalle)
plot(lmPuntosCalle)

```

Podemos ver como tenemos unos valores de los parámetros de nuestra aproximación con p valores muy significativos.
Sin embargo, si observamos la gráfica qqplot, la tendencia no es lineal.
Para conseguir un mejor ajuste, realizaremos una transformación de la variable puntos mediante Box-Cox.

```{r}
install.packages("MASS")  
library(MASS)

boxcox(lmPuntosCalle)
```

El mejor ajuste que nos devuelve Box-Cox es con \lambda=2.
Por tanto,

```{r}
lmPuntosCalle2 = lm((nadadoresPruebas$points)^2~nadadoresPruebas$lane)
summary(lmPuntosCalle)
plot(lmPuntosCalle)
```

##!!!q
ue alguien interprete esto porque no me entero:)

### Daytime

Nos genera curiosidad, por su formato, cómo se distribuye daytime, luego veamos:

```{r}
ggplot(nadadoresPruebas, aes(daytime)) + geom_bar(width=0.7, colour="red", fill="skyblue") + ggtitle("Daytime en los que se producen las pruebas")
```

Vemos que, aunque podríamos sacar alguna conclusión ya, el valor de la variable daytime debería tener el formato hora/minutos.
Por ello, lo realizamos:

```{r}
# Función para convertir
convertir_a_hhmm <- function(tiempo_numerico) {
  # Convertir el número a un string y separar horas y minutos
  horas <- tiempo_numerico %/% 100
  minutos <- tiempo_numerico %% 100
  
  # Crear un objeto de tiempo en formato hh:mm
  tiempo_formateado <- sprintf("%02d:%02d", horas, minutos)
  return(tiempo_formateado)
}

# Aplicar la función a todos los tiempos
tiempos_hhmm <- sapply(nadadoresPruebas$daytime, convertir_a_hhmm)
head(tiempos_hhmm)

```

Ahora representamos estos tiempos en una gráfica.
De esta manera, el lector puede visualizarlo sin tener que imaginar su conversión, como en el gráfico de antes.

```{r}
# Crear la columna 'tiempo_hhmm'
nadadoresPruebas$tiempo_hhmm <- sapply(nadadoresPruebas$daytime, convertir_a_hhmm)

# Convertir la nueva columna 'tiempo_hhmm' a formato POSIXct
nadadoresPruebas$tiempo_hhmm <- as.POSIXct(nadadoresPruebas$tiempo_hhmm, format = "%H:%M")

# Ahora puedes hacer el histograma
ggplot(nadadoresPruebas, aes(x = tiempo_hhmm)) +
  geom_histogram(binwidth = 3600, color = "black", fill = "blue") +  # binwidth en segundos (3600 segundos = 1 hora)
  scale_x_datetime(date_labels = "%H:%M", breaks = "1 hour") +  # Etiquetas de tiempo
  labs(title = "Frecuencia de Tiempos",
       x = "Tiempo (hh:mm)",
       y = "Frecuencia") +
  theme_minimal()

```

Luego, podemos observar de manera clara que, cada día de competición constaba de 2 sesiones, una matinal y otra vespertina, y que las franjas horarias van, por la mañana de 9:30 a 12:30, y por la tarde de 17:30 a 19:30.
Observamos que el número de nadadores que nadan por la mañana es mucho mayor al de por la tarde.
Vamos a investigar porqué:

#### Pruebas matinales y vespertinas.

Vamos a ver un resumen de qué pruebas se nadan por la mañana y cuáles por la tarde:

```{r}
nadadoresPruebas$tiempo_hhmm<- as.POSIXct(nadadoresPruebas$tiempo_hhmm, format = "%H:%M")
#intervalo para las matinales
limite_inferior1 <- as.POSIXct("09:30", format = "%H:%M")
limite_superior1 <- as.POSIXct("13:00", format = "%H:%M")
#intervalo para las vespertinas
limite_inferior <- as.POSIXct("17:00", format = "%H:%M")
limite_superior <- as.POSIXct("20:00", format = "%H:%M")
#Creamos las tablas
pruebasMatinales<-subset(nadadoresPruebas, nadadoresPruebas$tiempo_hhmm >= limite_inferior1 & nadadoresPruebas$tiempo_hhmm <= limite_superior1)

pruebasVespertinas<-subset(nadadoresPruebas, nadadoresPruebas$tiempo_hhmm >= limite_inferior & nadadoresPruebas$tiempo_hhmm <= limite_superior)
```

Bien, dividida ya nuestras pruebas en la sesion matinal y la vespertina, veamos un resumen de los datos:

```{r}
dim(pruebasMatinales)
dim(pruebasVespertinas)
```

De aquí observamos que, mientras que por las mañanas se nada un 75% de las pruebas del mundial, por las tardes sólo se nada un 25%.
Veamos si hay alguna variable que nos pueda ayudar:

```{r}
print("Resumen de rondas nadadas en sesiones matinales.")
summary(pruebasMatinales$round)
print("Resumen de rondas nadadas en sesiones vespertinas.")
summary(pruebasVespertinas$round)
```

Luego podemos concluir que, el formato que sigue el mundial de Kazán 2015 es, nadar por las mañanas las series preliminares de cada prueba, mientras que por las tardes sólo nadan los nadadores clasificados a semifinales y finales.

##Estudios relacionados con los puntos.
´

Veamos las posibles relaciones de puntos con las demás variables:

### Mejor nadador por prueba nadada. MVP de los mundiales.

Veamos ahora cómo se distribuyen los puntos:

```{r}
ggplot(nadadoresPruebas, aes(x = points)) +
geom_density() +
ggtitle("Distribución. points")
```

Observamos que la mayoría de puntos se encuentran a partir de los 750/800 puntos, y esto, tiene sentido si razonamos que para entrar a los mundiales de natación, se necesitan unas marcas mínimas (una cantidad de puntos preestablecida).
Luego es normal encontrar una gran cantidad de datos que tengan más de 750 puntos ya que había un "corte" para la inscripción en la competición.
Esto hace que la gráfica no esté más distribuida por todos los posibles valores de puntos.

Ahora nos surge la siguiente pregunta: *¿Quién rindió mejor en los campeonatos?*.

Podemos buscar el nadador que hizo más puntos:

```{r}
datos2015[which.max(datos2015$points), ]
```

Observamos que la nadadora que cosechó más puntos en una prueba fue Katie Ledecky en los 1500 metros.
Buscando, casualmente observamos que batió el récord[<https://www.rtve.es/deportes/20150803/ledecky-bate-record-del-mundo-1500-libres/1193160.shtml>] del mundo en dicha prueba.

Ahora, vamos a buscar al nadador que, en promedio, consiguió más puntos, podríamos denominarlo el *MVP* del Mundial Kazán 2015.
Para ello:

```{r}
#Usamos nadadoresPruebas, donde tenemos cada nadador y la prueba que realizó. 

media_puntos <- aggregate(nadadoresPruebas$points ~ nadadoresPruebas$athleteid, data = nadadoresPruebas, FUN = mean)
media_puntos <- media_puntos[order(media_puntos$`nadadoresPruebas$points`, decreasing = TRUE), ]
media_puntos<- rename(media_puntos, "athleteid"="nadadoresPruebas$athleteid")
media_puntos<-rename(media_puntos, "meanPoints"="nadadoresPruebas$points")

head(media_puntos,5)
```

El atleta con id 108588 es el que hizo más puntos, veamos quien es:

```{r}
nadadoresPruebas[nadadoresPruebas$athleteid==108588	, ]
```

Luego, el MVP fue el británico Adam Peaty, que nadó 50, 100 y 200 braza.
Veamos quiénes fueron los integrantes del podio:

```{r}
nadadoresParticipantes[nadadoresParticipantes$athleteid==102630 | nadadoresParticipantes$athleteid==105594, ]
```

Completaron el podio Cameron Van der Burgh, de Sudáfrica, y Katie Ledecky.

### Puntos. Hombres vs Mujeres

A continuación, vamos a comparar los puntos realizados por hombres y mujeres, para ver si podemos sacar alguna conclusión.

Primeramente, vamos a ver la función de densidad:

```{r}
ggplot(nadadoresPruebas, aes(x = points, colour=gender)) +
geom_density() +
ggtitle("Distribución. Puntos por sexo")

```

A priori, parece haber dos distribuciones muy igualadas.

```{r}
modelo= lm(points ~ gender, data = nadadoresParticipantes)

summary(modelo)

# Realizar ANOVA
anova_puntos_genero <- aov(points ~ gender, data = nadadoresParticipantes)

# Ver el resumen del resultado
summary(anova_puntos_genero)

```

### Puntos. ¿La edad influye?

Una buena manera de medir el rendimiento con respecto a la edad del nadador, es verlo a través de los puntos obtenidos.

```{r}
#QUERIA PONERLO CON COLORES Q SE VEA MEJOR EL GRAFICO DE CALOR(POR SER CREATIVOS Y TAL)
resumen_puntos <- nadadoresPruebas %>%
  group_by(edad, points) %>%
  summarise(frecuencia = n(), .groups = 'drop')

# Crear el gráfico de calor
ggplot(resumen_puntos, aes(x = edad, y = points)) +
  geom_tile(aes(fill = frecuencia), color = "white") +
  scale_fill_gradient(low = "pink", high = "darkred",limits = c(min(resumen_puntos$frecuencia), max(resumen_puntos$frecuencia)))+
  theme_bw() +
  labs(title = "Gráfico de Calor: Edades y Puntos Obtenidos",
       x = "Edad",
       y = "Puntos Obtenidos") +
  theme(panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank())
```

###Estudio de puntos por país.
Veamos el número de puntos por países

###Modelo de regresión lineal para tiempo de reaccion vs tiempo

```{r}
# Esto no funciona porque las dos variables continuas tienen distinto tamaño
# Hay que gestionar los NAs previamente
# Además, como solo se está trabajando con dos variables continuas, no tiene sentido hacer pairs
# Realmente es un único plot
# pairs(nadadoresPruebas$points,splitswimtime)
```

*poner aqui todo juntos en un pairs* Empezamos viendo la relación lineal (que ya sabemos que será alta) entre puntos y tiempo.
Es evidente que a mayor tiempo, hay menos puntos.
Veámoslo

```{r}
nadadoresPruebas50crol<- nadadoresPruebas[nadadoresPruebas$distance==50 & nadadoresPruebas$stroke=='FREE', ]
t= nadadoresPruebas50crol$swimtime
p= nadadoresPruebas50crol$points
cor(t,p)
#verlo pero 
```

Esto no es de mucho estudio, ya que es lo lógico.

Veamos los puntos respecto al tiempo de reacción:

```{r}
nadadoresPruebas<- na.omit(nadadoresPruebas)
x= nadadoresPruebas$points
y=nadadoresPruebas$reactiontime
```

```{r}
cor(x,y)
```

Parecen no estar correlacionadas el tiempo de reaccion y los puntos de manera lineal.
Pero a lo mejor, en pruebas específicas , como las pruebas de distancias cortas la correlación es mayor.

```{r}
nadadoresPruebas50<- nadadoresPruebas[nadadoresPruebas$distance==50, ]
X=nadadoresPruebas50$reactiontime
Y=nadadoresPruebas50$points
cor(X,Y)
```

Ya tenemos nuestro objetivo de estudio ya que para comenzar con la modelización estadística, debemos contextualizar el problema, definiendo objetivos y variables.

Queremos investigar si existe relación entre el tiempo de reacción y puntos.
Una pregunta que puede surgirnos es, ¿A mayores valores del tiempo de reacción, hay mayores valores de puntos?
Luego, nuestro objetivo será saber si hay algún tipo de relación lineal, y las variables, por ende, serán tiempo de reacción y puntos.
La variable tiempo de reacción, será nuestra variable independiente, y puntos será la variable dependiente.

A continuación, procedemos a realizar una inspección gráfica simple, para identificar tendencias.

```{r}
plot(X,Y,xlab="Tiempo de reacción",ylab="Puntos")
```

```{r}
cov(X,Y)
```

Esta covarianza, positiva y grande en valor absoluto, nos indica que hay relación negativa entre las variables(ya lo habíamos intuido pero gracias al signo lo hemos confirmado).

A pesar de la confirmación, en este momento nos surge un problema, pues, la covarianza toma valores en todos los números reales, dependiendo de las magnitudes del tiempo de reacción y puntos, y de sus unidades .
Por eso, calcularemos el coeficiente de correlación lineal, que se obtiene tipificando la covarianza, es decir, dividiendo la covarianza entre las desviaciones típicas muestrales (obteniendo un coeficiente entre -1 y 1)

```{r}
cor(X,Y)
```

De manera adicional, podemos incluir histogramas marginales en cada eje del gráfico, para ello usamos las librerías `ggplot2` y `ggExtra`.

```{r}
datos<-data.frame(x=X,y=Y)

p<-ggplot(datos, aes(x = X, y = Y)) +
  geom_point()
#vemos la nube de puntos 
print(p)
#Especificamos que se añadan histogramas en los márgenes
ggMarginal(p, type = "histogram")

```

Como hemos visto, si la relacion lineal es fuerte tiene sentido querer ajustar una recta a la nube de puntos.
Es decir, considerar un modelo de regresion lineal simple.

La función que ajusta el modelo de regresión lineal simple en R es `lm`(con parametros B_0,B_1 y sigma\^2), directamente hacemos un `summary` para que nos devuelva la información más importante, aunque realmente `lm` calcula muchas cosas: estimaciones, residuos, predicciones, etc.

```{r}
lm=lm(Y~X)
summary(lm)
```

Podemos añadir la recta de regresión al gráfico usando el comando `abline`, y el objeto donde hemos guardado el ajuste de la recta, en este caso `lm4`:

```{r}
#representamos
plot(X,Y)
#añadimos la recta de regresion
abline(lm)
```

Los coeficientes de la regresión estimados también están en el objeto donde hemos guardado el ajuste, en `lm`

```{r}
#generamos un vector con los coeficientes de la regresion
coeficientes=lm$coefficients
#comprobamos que es lo mismo que nos salía en el summary
coeficientes
```

Sabemos que el valor de los puntos cuando X=0, es decir, que el tiempo de reacción sea cero, es de 1809 aproximadamente.
Este parámetro no tendría sentido, pues el tiempo de reacción nunca va a ser cero.
Por otro lado la pendiente es -1562.315, lo que nos muestra que por cada valor que aumenta X, Y aumenta lo indicado.

## Prueba 800m Libre femenino.

VISUALIZAR TIPOS DE NADADORES VIENDO LOS PARCIALES

Veamos qué nadadores nadaron el 800 libre femenino:

```{r message=FALSE, warning=FALSE, paged.print=TRUE}
nadadoras800free<-nadadoresPruebas[nadadoresPruebas$distance==800 & nadadoresPruebas$gender=="F", ]

dim(nadadoras800free)
```

Tenemos que 52 chicas nadaron el 800 libres, algunas de ellas dos veces ya que pasaron a la final.

Nos vamos a fijar en la final, para ello, filtramos otra vez los datos:

```{r}
nadadoras800free<-datos2015[datos2015$gender=="F" & datos2015$distance==800 & datos2015$round=="FIN", ]

```

Ahora, vamos a definir una tabla en la que nos va a importar el nombre, la suma total de tiempo al paso de cada parcial:

```{r}
nadadoras800free <- nadadoras800free %>%
  dplyr::select(lastname,firstname,gender,reactiontime,splitdistance,cumswimtime, swimtime)

```

Ahora vamos a representar cómo fue la carrera:

```{r}
# Ordenar los datos por tiempo
nadadoras800free <- nadadoras800free %>%
  arrange(splitdistance, cumswimtime)

# Crear un índice de posición
nadadoras800free <- nadadoras800free %>%
  group_by(splitdistance) %>%
  mutate(Posicion = rank(cumswimtime, ties.method = "first"))



ggplot(nadadoras800free, aes(x = splitdistance, y = Posicion, group = lastname)) +
  geom_line(aes(color = lastname, alpha = 1), size = 2) +
  geom_point(aes(color = lastname, alpha = 1), size = 4) +
  scale_y_reverse(breaks = 1:nrow(nadadoras800free))
```

Observamos como Ledecky lidera toda la carrera, Boyle alcanza al paso de los 100 metros la segunda posición y la mantiene.
La pelea por la última medalla en juego dura hasta los 700 metros, donde un adelantamiento de Carlin a Ashwood hace que la nadadora Jaz Carlin alcance el bronce olímpico.

## Datos NA.

# PCA's

Realizaremos ahora el análisis de componentes principales del 800m libres femenino:

## PCA. 800M libres femenino

Lo primero que debemos hacer es cargar los datos:

```{r}
prueba800libresPreliminar<- datos2015[datos2015$distance==800 & datos2015$gender=="F" & datos2015$stroke=="FREE" & datos2015$round=="PRE", ]

prueba800libresPreliminar <- prueba800libresPreliminar %>%
    dplyr::select(lastname, reactiontime, splitdistance, splitswimtime, edad)
```

Bien, ahora, debemos encontrar la manera de crear una tabla en la que nos quedemos con el nombre, apellido y parciales.

```{r}
pruebawide <- prueba800libresPreliminar %>%
  pivot_wider(names_from = splitdistance,       # Los valores de 'Split' serán los nombres de las columnas
              values_from =splitswimtime)     # Los valores de 'Tiempo' llenarán las celdas
row.names(pruebawide) <- pruebawide$lastname # esto es para llamar a las filas con el nombre de los nadadores
pruebawide
#omito los valores nulos: 
pruebawide<- na.omit(pruebawide)
```

Ahora que ya tenemos nuestra tabla hecha, vamos a hacer el PCA:

```{r}
prcomp(pruebawide[,-1], scale=T)
summary(prcomp(pruebawide[,-1],scale=T))
```

Viendo el pca, observamos que con la primera componente, tenemos un 85% de la varianza.
Con pc2 un 5%, luego con esas dos podemos explicar un 90% de los datos.

Ahora, veamos cómo se ven los datos:

```{r}
plot(prcomp(pruebawide[,-1],scale=T)$x[,1:2], type="n")
text(prcomp(pruebawide[,-1],scale=T)$x[,1:2],rownames(pruebawide))


```

Bien, así observamos los nombres.
Veamos cómo queda el biplot:

```{r}
biplot(prcomp(pruebawide[,-1],scale=T))
```

## PCA 100 mariposa femenino (Javier)

En primer lugar, vamos a crear una nueva tabla llamada prueba100MariposaFem en la cuál nos quedamos con todas las pruebas de atletas femeninos, de distancia igual a 100 metros y de estilo de nado mariposa.
A continuación, nos quedamos con las columnas de lastname, reactiontime, splitdistance, splitswimtime y swimtime de la tabla prueba100MariposaFem.

```{r}
# Filtro de pruebas de 100m mariposa femenino
prueba100MariposaFem <- datos2015[datos2015$distance==100 & datos2015$gender=="F" & datos2015$stroke=="FLY" & datos2015$round =="PRE",]

# Selección de columnas relevantes
prueba100MariposaFem <- prueba100MariposaFem %>% dplyr::select(lastname, reactiontime, splitdistance, splitswimtime)
```

```{r}
prueba <- prueba100MariposaFem %>%
  pivot_wider(names_from = splitdistance,       # Los valores de 'Split' serán los nombres de las columnas
              values_from =splitswimtime)     # Los valores de 'Tiempo' llenarán las celdas

#Eliminamos duplicados y NA de la columna 'lastname'
prueba <- prueba[!duplicated(prueba$lastname) & !is.na(prueba$lastname), ]

prueba <- as.data.frame(prueba)

# Asignar los nombres de fila como el apellido del nadador
row.names(prueba) <- prueba$lastname

#Eliminamos filas con NA restantes
prueba <- na.omit(prueba)
```

Con todo esto, estamos preparados para realizar el PCA:

```{r}
#Realizamos el PCA
pca_100mariposafemenino <- prcomp(prueba[,-1], scale=T)

# Resultados del PCA
summary(pca_100mariposafemenino)

#Visualización del PCA
biplot(pca_100mariposafemenino)
```

Obtenemos que la componente 1 (PC1) explica un 74,23% de las prueba y la 2 un 23,28%.
Luego

## PCA. 50 mariposa masculino (Salma)

Cargamos los datos:

```{r}
prueba50MariposaMasc<- datos2015[datos2015$distance==50 & datos2015$gender=="M" & datos2015$stroke=="FLY", ]

prueba50MariposaMasc <- prueba50MariposaMasc %>%
    dplyr::select(lastname, reactiontime, splitdistance, splitswimtime, edad, swimtime)
```

De manera análoga, creamos una tabla en la que nos quedamos con el nombre, apellido y parciales

```{r}
pruebita <- prueba50MariposaMasc %>%
  pivot_wider(names_from = splitdistance,       # Los valores de 'Split' serán los nombres de las columnas
              values_from =splitswimtime)     # Los valores de 'Tiempo' llenarán las celdas
pruebita
#omito los valores nulos: 
pruebita<- na.omit(pruebawide)
```

Hacemos el PCA:

```{r}
prcomp(pruebita[,-1], scale=T)
summary(prcomp(pruebita[,-1],scale=T))
```

Viendo el pca, observamos que con la primera componente, tenemos un 85% de la varianza.
Con PC2 un 5%.
Con esas dos podemos explicar un 90% de los datos.

```{r}
plot(prcomp(pruebita[,-1],scale=T)$x[,1:2])
```

# Tareas por hacer e ideas surgidas:

-   Ver quién "rindió" mejor en los mundiales entre hombres y mujeres y respecto a los puntos.
-   Ver si hay relación entre puntos y edad.
-   ¿Qué hacemos con los datos nulos?
-   Sacar conclusiones del PCA.
-   Hacer el clustering.
-   Hacer un pca del 100 braza masculino y clustering
-   Hacer un pca del 50 mariposa masculino y clustering(cada uno que haga un PCAhecho) -EDA el grafico de paises en vez de por numero de personas, el numero de puntos

# Cluster(queda por explicar)

```{r}
kmedias=kmeans(prcomp(pruebawide[,-1],scale=T)$x[,1:2], centers=2, nstar=25)

kmedias
```
