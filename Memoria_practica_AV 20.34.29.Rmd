---
title: "Mundial de natación de Kazán 2015"
author: "4to mates"
date: "`r Sys.Date()`"
output:
  html_document:
    theme: flatly
    toc: yes
    toc_float:
      collapsed: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# Cargamos las librerias que vamos necesitando a lo largo del codigo
library(dplyr)
library(rstatix)
library(ggplot2)
library(tidyr)
```

# Introducción

El conjunto de datos obtenidos abarca los resultados del Campeonato Mundial de Natación Kazán 2015, con los correspondientes datos de cada nadador y prueba.

Los datos han sido extraídos de [Omega](http://www.omegatiming.com/File/Download?id=00010F0200FFFFFFFFFFFFFFFFFFFF08), la plataforma oficial de tiempos de la World Aquatics.

El conjunto de datos contiene información sobre los nadadores (fecha de nacimiento, país, id), y sobre la prueba nadada (tiempo de reacción, parciales, tiempo total, estilo, serie).

Según la descripción oficial de los datos, las variables que conforman el conjunto de datos son:

-   athleteid: id del nadador (único)
-   lastname: Apellidos del nadador
-   firstname: El nombre del nadador
-   birthdate: Fecha de nacimiento del nadador
-   gender: Género del nadador/a
-   name: Nombre del país
-   code: abreviatura del país.
-   eventid: id de la prueba nadada (único)
-   heat: Serie en la que nadaron
-   lane: Calle en la que nadaron (0 a 9)
-   points: puntos FINA que realizaron. (es una "estimación" entre el mejor tiempo o récord del mundo, y el tiempo realizado. )
-   reactiontime: Tiempo de reacción en la salida.
-   swimtime: tiempo tardado
-   split: Parcial
-   cumswimtime: Tiempo acumulado en el parcial
-   splitdistance: Distancia del parcial
-   daytime: hora a la que se nadó
-   round: ronda (preliminar, semifinal, final)
-   distance: distancia de la prueba
-   relaycount: Número de relevista.
-   stroke: Estilo de nado en el que se realizó la prueba.
-   splitswimtime: Tiempo del parcial (50m)

# Entender los datos.

Primeramente, vamos a leer los datos:

```{r}
datos2015<-read.csv("~/Desktop/maria del carmen/Prueba/2015_FINA.csv", header=TRUE, sep = ',')
```

Una vez nuestro programa los ha leído, vamos a echar nuestro primer vistazo:

```{r}
dim(datos2015)
```

Tenemos en total 11423 filas y 22 variables o columnas.

Veámos la primera ocurrencia de nuestra tabla:

```{r}
head(datos2015,1)
```

Observamos Noel Borshi, nadadora albanesa nacida un 13 de febrero de 1996, que tiene como id el número (100784). Noel Borshi nadó la prueba 1 en la serie 1 y carril 4. Nadó el 100m Mariposa en la ronda preliminar con un tiempo final de 63.65s y pasó por el primer parcial (50m) en 29.63 segundos.

# Análisis exploratorio de datos

## Resumen de los datos.

A continuación, vamos a ver un resumen de los datos:

```{r}
summary(datos2015)
```

De aquí, podemos obsevar que tenemos algunos valores nulos (NA's), además se puede observar que, durante toda la competición, como máximo hubo 12 series y como mínimo 1. Que la piscina disponía de 10 carriles numerados del 0 al 9. También observamos que se nadaron pruebas de 50 y hasta 1500 metros.

Observamos que tenemos algunas variables categóricas, luego vamos a cargar la libreria "dyplr" y vamos a intentar visualizarlas de una mejor manera:

```{r}
datos2015<- datos2015 %>% convert_as_factor(gender,name,code,round,heat,lane,stroke)
```

Bien, ahora, visualicemos otra vez el resumen:

```{r}
summary(datos2015)
```

Bien, ahora podemos observar muchas más cosas, observamos que las variables name y code toman absolutamente los mismos valores, luego seguramente podamos reducir en una variable el conjunto de datos. Vemos también que se nadaron pruebas de espalda, braza, mariposa, crol y estilos Individual. También observamos que las pruebas las disputaron hombres y mujeres. Podemos observar tamibén que el menor tiempo de reacción fue de 0.42 y el mayor de 0.97.

Viendo los datos, observamos que cada nadador tiene en una prueba concreta, tantas filas como parciales tenía en esa prueba, luego es obvio que para conocer mejor algunas variables, vamos a necesitar limpiar los datos para que los elementos repetidos no nos estorben.

## Estudio sobre el número de nadadores, su género, país y edad.

### Edad

Lo primero que vamos a hacer, va a ser crear una nueva variable, llamada edad, ya que birthdate no nos va a dar tanto juego.

```{r}
datos2015$birthdate <- as.Date(datos2015$birthdate)
#Calculamos la edad
fechaKazan<- as.Date("2015-07-24")
datos2015$edad <- as.numeric(difftime(fechaKazan, datos2015$birthdate, units = "weeks")) %/% 52  # Convertir de semanas a años
```

Ahora, vamos a crear una nueva tabla en la cual vamos a obtener sólamente los nadadores (sin repetir) que participaron en la competición:

```{r}
nadadoresParticipantes <- datos2015 %>%
  distinct(athleteid, .keep_all = TRUE)
```

Bien, ahora, vamos a observar qué sucede con las edades:

```{r}
summary(nadadoresParticipantes$edad)
```

Observamos que la edad máxima fue de 38 años, la media fue de 21.32 años, y el participante con menos edad fue de 10 años.

Aquí un enlace a la [noticia](https://www.rtve.es/deportes/20150807/nina-10-anos-alzain-tareq-asombra-a-natacion-mundial/1195782.shtml#:~:text=Se%20llama%20Alzain%20Tareq%2C%20tiene,estrella%20medi%C3%A1tica%20de%20la%20jornada.) sobre la joven nadadora de 10 años.

Podríamos echar un vistazo y ver si la noticia se refiere a los datos que tenemos:

```{r}
datos_edad_10 <- datos2015[datos2015$edad == 10, ]
datos_edad_10
```

Se trata de una nadadora de Bahrain que nadó el 50 mariposa y el 50 libres.

Veámos como se distribuye en una gráfica de densidad las edades:

```{r}
ggplot(nadadoresParticipantes, aes(x = edad)) +
geom_density() +
ggtitle("Distribución. Edades.")
```

Observamos que se concentra el 50% de los datos entre los 19 y los 24.


View
### Géneros participantes.

Veamos el número exacto de mujeres y hombres en la competición:

```{r}
summary(nadadoresParticipantes$gender)
```

Luego, observamos que hay 616 hombres y 494 mujeres que participaron en los mundiales de Kazán 2015.

Observemos ahora cómo se distribuyen los hombres y las mujeres y sus respectivas edades:

```{r}
hist_varF <- ggplot(data = subset(nadadoresParticipantes,gender== 'F')) +
geom_histogram(mapping = aes(x = edad), binwidth = 2)

hist_varM <- ggplot(data = subset(nadadoresParticipantes,gender== 'M'))+
geom_histogram(mapping = aes(x = edad), binwidth = 2)
hist_varF 
hist_varM
```

Como podemos observar, la media de edades tiende a ser la misma en ambos géneros. Sin embargo, se puede observar como parece ocurrir que las mujeres comienzan a competir a menor edad.

### Nacionalidades.

Veamos un resumen de los datos sobre nacionalidades:

```{r}
summary(nadadoresParticipantes$name)
```

Luego observamos que China fue la que más participantes llevó, con un total de 39, EEUU llevó 37 nadadores, Italia cierra el podio con 31 nadadores inscritos.

*VER SI SE PUEDEN ESTIRAR MÁS ESTOS DATOS*

## Estudio sobre los eventos, reactiontime, lane, heats y daytime:

Primeramente, vamos a elaborar una tabla que refleje nadadores y pruebas nadadas (lo único que vamos a desechar son los parciales (filas) en caso de que la prueba sea de más de 50 metros.)

Para ello, primeramente debemos saber si cada prueba y cada tipo de prueba (preliminar, final o seminifinal), tiene un id de evento distinto, para ello seleccionamos algún nadador que haya nadado en la misma prueba varias rondas:

```{r}
ejemplo<-datos2015[datos2015$distance == 100 & datos2015$stroke=="BACK" & datos2015$code=="AUS", ]
head(ejemplo,6)
```

Bien, vemos que el australiano nadó tanto las preliminares, como las semifinales como la final y el eventid era distinto, luego parece que podemos seguir con nuestro estudio:

```{r}
nadadoresPruebas <- datos2015 %>%
  distinct(eventid, athleteid, .keep_all = TRUE)

```

Los datos creados, reflejan nadadores y pruebas nadadas.

### Prueba 800m Libre femenino:

Veamos qué nadadores nadaron el 800 libre femenino:

```{r}
nadadoras800free<-nadadoresPruebas[nadadoresPruebas$distance==800 & nadadoresPruebas$gender=="F", ]

dim(nadadoras800free)
```

Tenemos que 52 chicas nadaron el 800 libres, algunas de ellas dos veces ya que pasaron a la final.

*AÑADIR MAS COSAS SI QUEREIS*

### reactiontime

Veamos cómo se distribuyen los datos de tiempo de reacción de todos los nadadores:

```{r}
ggplot(nadadoresPruebas, aes(x = reactiontime)) +
geom_density() +
ggtitle("Distribución. reactiontime")

```

Parece que los datos siguen una distribución normal a priori. Vamos a ir más alla para intentar sacar conclusiones más profundas.

Vamos a comparar a comparar las funciones de densidad de chicos y chicas en general:

Vamos a comparar ahora las funciones de densidad de las chicas en la prueba de 800m libres y 50m libres:

Primeramente calculamos el conjunto de datos del *50m* libres femenino:

```{r}
nadadorasPruebas<-nadadoresPruebas[nadadoresPruebas$gender=="F" & nadadoresPruebas$stroke=="FREE", ]
```

```{r}
ggplot(nadadoras800free, aes(x = reactiontime)) +
geom_density() +
ggtitle("Distribución. reactiontime 800m free Women")

ggplot(nadadoras50free, aes(x=reactiontime))+geom_density()+ggtitle("Dstribución. reactiontime 50m free Women")
```

Se observa cómo en la prueba de 50 hay más nadadoras que tarden menos de 0.7 que en la de 800m.

*Podemos comparar a los chicos para ver si es cierto lo supuesto*

### Calles usadas

Veamos cómo se distribuyen las calles usadas:

```{r}
ggplot(nadadoresPruebas, aes(nadadoresPruebas$lane)) + geom_bar(fill = "orange") +
theme_bw()
```

Se observa que las calles menos usadas son tanto la 0 como la 9.

### Points

Veamos ahora cómo se distribuyen los puntos:

```{r}
ggplot(nadadoresPruebas, aes(x = points)) +
geom_density() +
ggtitle("Distribución. points")
```

Observamos que la mayoría de puntos se encuentran a partir de los 750/800 puntos, y esto, tiene sentido si razonamos que para entrar a los mundiales de natación, se necesitan unas marcas mínimas (una cantidad de puntos preestablecida). Luego es normal encontrar una gran cantidad de datos que tengan más de 750 puntos ya que había un "corte" para la inscripción en la competición. Esto hace que la gráfica no esté más distribuida por todos los posibles valores de puntos.

### Daytime

Nos genera curiosidad, por su formato, cómo se distribuye daytime, luego veamos:

```{r}
ggplot(nadadoresPruebas, aes(daytime)) + geom_bar(width=0.5, colour="red", fill="skyblue") + ggtitle("Daytime en los que se producen las pruebas")
```

Luego, podemos observar de manera clara que, cada día de competición constaba de 2 sesiones, una matinal y otra vespertina, y que las franjas horarias iban aproximadamente desde 930 (9:30 am) hasta las 1130 (MIRAR CÓMO HACER ESTE GRAFICO DE OTRA MANERA.)

#PCA's

Realizaremos ahora el análisis de componentes principales del 800m libres femenino:

## PCA. 800M libres femenino

Lo primero que debemos hacer es cargar los datos:

```{r}
prueba800libresPreliminar<- datos2015[datos2015$distance==800 & datos2015$gender=="F" & datos2015$stroke=="FREE" & datos2015$round=="PRE", ]

prueba800libresPreliminar <- prueba800libresPreliminar %>%
    select(lastname,firstname,gender, reactiontime, splitdistance, splitswimtime, edad, swimtime)
```

Bien, ahora, debemos encontrar la manera de crear una tabla en la que nos quedemos con el nombre, apellido y parciales

```{r}
pruebawide <- prueba800libresPreliminar %>%
  pivot_wider(names_from = splitdistance,       # Los valores de 'Split' serán los nombres de las columnas
              values_from =splitswimtime)     # Los valores de 'Tiempo' llenarán las celdas
pruebawide
```

Lo tenemos!







  
  
  
  
  
  
  
##PROFUNDIZAMOS EN LAS EDADES
Vamos a ver si las distintas edades de los nadadores dependen del género del nadador.

```{r}
ggplot(nadadoresParticipantes, aes(x = edad, colour = gender)) +
  geom_density(lwd=2, linetype=1)
```

Como las curvas están diferenciadas por colores (uno para cada género), podemos observar si la distribución de edades difiere entre hombres y mujeres.Parece que la distribución está ligeramente desplazada a la derecha para los hombres, esto indica que los hombres tienden a ser mayores en promedio que las mujeres. Esta diferencia en la distribución de edades entre los géneros puede llevarte a realizar distintos test estadísticos para confirmar si la diferencia es significativa.


```{r}
t.test(edad~gender,data=nadadoresParticipantes)

```

Hemos comparado las medias de edad entre mujeres (grupo F) y hombres (grupo M), tomando como hipótesis nula que las medias de edad entre mujeres y hombres son iguales, y cómo hipótesis alternativa que las medias de edad entre mujeres y hombres son diferentes. Aunque el resultado del t-test muestra que hay una diferencia estadísticamente significativa(el p-valor es muy pequeño) entre las edades medias de hombres y mujeres (aproximadamente 1.16 años), en términos prácticos, esta diferencia es relativamente pequeña. En este caso, puede no ser relevante en términos de la experiencia o desempeño de los nadadores.

No obstante, proseguimos en nuestro análisis exploratorio.

```{r}
tabla1<-table(nadadoresParticipantes$edad>30,nadadoresParticipantes$gender)
chisq.test(tabla1)
```
Por el resultado del siguiente test aplicado,podemos concluir con que no hay asociación significativa: Dado que el p-valor es 0.47, entre ser mayor de 30 años y el género de los nadadores en nuestros  datos. En términos sencillos,la edad no parece estar relacionada con el género de los nadadores en cuanto a si son mayores de 30 años.

```{r}
tabla2<-table(nadadoresParticipantes$edad<20,nadadoresParticipantes$gender)
chisq.test(tabla2)
```

Hay una diferencia considerable entre las frecuencias observadas (cuántos hombres y mujeres son menores de 20 años) y las frecuencias esperadas bajo la hipótesis nula (que no hay asociación entre edad y género para menores de 20 años). Esto sugiere ir un paso más allá, ¿Hay más mujeres menores de edad que hombres menores de edad?
  
  
  ```{r}
tabla3<-table(nadadoresParticipantes$edad<18,nadadoresParticipantes$gender)
chisq.test(tabla3)
```

Los resultados sugieren que el género y la edad (si son menores de 18 años) están significativamente relacionados en tu conjunto de datos de nadadores. Esto podría tener implicaciones para el análisis del rendimiento y la participación en competiciones.
Veamos números,
```{r}
tabla3

#Calcular los totales
totales <- colSums(tabla3)

#Calcular el porcentaje de nadadores menores de 18 años por género
porcentajes <- (tabla3[2, ] / totales) * 100  
# fila 2 son los menores de 18

porcentajes
```


Aproximadamente 2 de cada 10 mujeres son menores de 18 años, mientras que solamente 1 de cada 10 hombres es menor de 18 años.

```{r}
library(dplyr)

#Crear una nueva columna para clasificar por edad
nadadoresParticipantes <- nadadoresParticipantes %>%
  mutate(grupo_edad = ifelse(edad < 18, "Menores de 18", "18 y más"))

#Resumir el número de participantes en cada prueba por grupo de edad(CODIGO DE GOOGLE)
resumen_pruebas <- nadadoresParticipantes %>%
  group_by(grupo_edad , distance) %>%  # Agrupar por grupo de edad y prueba(LO MIRO POR DISTANCIAS)
  summarise(num_participantes = n(),.groups = "drop") %>%  #Contar el número de participantes
  ungroup() %>%  # Quitar agrupación
  arrange(grupo_edad, desc(num_participantes))  #Ordenar los resultados

# Mostrar el resumen
resumen_pruebas

```

Tenemos la distancia de 100 metros, con 405 participantes. Es la distancia más popular entre los nadadores mayores de 18 años. Le sigue la distancia de 209 participantes, la de 200 metros.
200 metros: Con 209 participantes, sigue siendo una distancia muy popular.
La participación disminuye considerablemente en distancias más largas, como 1500 metros con solo 13 participantes.
Para los menores de 18 años tenemos carreras de 100 metros con 75 participantes, esta es la distancia más frecuentada, aunque significativamente menos que el grupo de 18 años o más.
La participación en distancias más largas, como 400 metros, es aún más baja, con solo 19 participantes.

Los nadadores mayores de 18 años tienen una participación significativamente mayor en todas las distancias en comparación con los menores de 18 años.
La mayor diferencia se observa en la distancia de 100 metros, donde hay 405 participantes en el grupo de 18 años o más, en comparación con solo 75 en el grupo de menores de edad.
La participación en distancias más largas tiende a ser baja en ambos grupos, pero la caída es más pronunciada en los menores de 18.

##no se como mirarlo solo para chicas(lo intente no me pegueis)









##paises 


```{r}
##si alguien sabe ocultar este codigo q esta en sucio
library(dplyr)
library(ggplot2)
library(ggimage)
library(countrycode)

datos2015<-read.csv("~/Desktop/maria del carmen/Prueba/2015_FINA.csv", header=TRUE, sep = ',')
#bueno explico pa tontos como se hace 

# NUESTRA TABLA ES nadadoresParticipantes
# Agregar el código ISO de dos dígitos, DIRAS PORQUE NO USAS CODE ESQ EN R PONE QUE TIENE Q SER DE DOS ASIQ ES LO Q TOCA HAY Q CONVERTIR 
#ASI LO PONE LA WEB 
nadadoresParticipantes$iso2 <- countrycode(nadadoresParticipantes$name, "country.name", "iso2c")
#UY SALTA ERROR PARECE QUE EN FINA, KOSOVO,MICRONESIA Y VIRGIN ISLAND NO SABE HACERLO
#VEO TODOS LOS NOMBRES PA BICHEAR 
nombres<- unique(nadadoresParticipantes$name) #NO REPETIR CLARO
print(nombres)

#Verificar qué nombres no fueron convertidos por si me olvido alguno
no_convertidos <- nadadoresParticipantes %>%
  filter(is.na(iso2)) %>%
  select(name)
print(no_convertidos)

#nombres problemáticos
manual <- data.frame(
  nombre = c("Fina", "Kosovo", "Micronesia", "Virgin Islands"),
  iso2 = c("FI", "XK", "FM", "VI")  
)

#Combina
nadadoresParticipantes <- nadadoresParticipantes %>%
  left_join(manual, by = c("name" = "nombre"), suffix = c("", ".nuevo")) %>%
  mutate(iso2 = ifelse(is.na(iso2), iso2.nuevo, iso2)) %>%
  select(-iso2.nuevo)  #Eliminar columna 


no_convertidos_final <- nadadoresParticipantes %>%
  filter(is.na(iso2)) %>%
  select(name)
print(no_convertidos_final)
#wue ya no hay ninguno no convertido

# Agregar variable de continente como hace la pagina
nadadoresParticipantes$continent <- countrycode(nadadoresParticipantes$iso2, "iso2c", "continent")
#vuelve a fallar

#continentess no asignados
continentes_no_asignados <- nadadoresParticipantes %>%
  filter(is.na(continent)) %>%
  select(iso2)
print(continentes_no_asignados)

#solo es XK(KOSOVO, Esta en europa para los catetos)
#manualmente el continente para Kosovo (XK)
nadadoresParticipantes <- nadadoresParticipantes %>%
  mutate(continent = ifelse(iso2 == "XK", "Europe", continent))  

#todos los continentes están asignados
continentes_final <- nadadoresParticipantes %>%
  filter(is.na(continent)) %>%
  select(iso2)

#siii
print(continentes_final)



#nadadores por país
resumen_paises <- nadadoresParticipantes %>%
  group_by(name, iso2, continent) %>%
  summarise(num_nadadores = n(), .groups = "drop") %>%
  arrange(desc(num_nadadores))  # Ordenar por número de nadadores
##esto esta muy guay podemos usarlo pa mas cosas ya que ya esta hecho
resumen_paises

#Crear un gráfico;metemos colores
paleta <- c("Americas" = "#0084ff", "Asia" = "#44bec7", 
                "Europe" = "#ffc300", "Oceania" = "#fa3c4c")

oda_bar <- resumen_paises %>% 
  ggplot(aes(x = reorder(name, num_nadadores), y = num_nadadores, fill = continent)) + 
  geom_flag(y = -10, aes(image = iso2), size = 0.05) +  
  geom_bar(stat = "identity") + 
  labs(title = "Participación de Nadadores por País",
       subtitle = "Datos de nadadores en competiciones",
       x = "País",
       y = "Número de Nadadores") +
  scale_fill_manual(values = paleta) +  # colores personalizados
  expand_limits(y = c(0, max(resumen_paises$num_nadadores) + 10)) +  # Aumentar el límite superior
  coord_flip() +  # Para hacer el gráfico horizontal
  theme_minimal()

# Imprimir el gráfico
print(oda_bar)

##lo de las banderas se me escapa y mira q he metido lo del flag pero creo que hay que crear una columna nueva donde aparezca los url de las banderas

```

Como tal se podria reducir y mejorar el gráfico para que sea más interpretable